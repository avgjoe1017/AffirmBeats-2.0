<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Affirmation Library - Admin</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0f0f1e;
            color: #e0e0e0;
            line-height: 1.6;
        }
        .container {
            display: flex;
            max-width: 100%;
            margin: 0;
            min-height: 100vh;
        }
        .sidebar {
            width: 250px;
            background: #1a1a2e;
            border-right: 1px solid #2a2a3e;
            padding: 20px;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
        }
        .sidebar h2 {
            color: #8b7ab8;
            font-size: 1.5rem;
            margin-bottom: 30px;
            padding-bottom: 15px;
            border-bottom: 1px solid #2a2a3e;
        }
        .nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 15px;
            margin-bottom: 8px;
            border-radius: 8px;
            text-decoration: none;
            color: #9e9eb0;
            transition: all 0.2s;
        }
        .nav-item:hover {
            background: #2a2a3e;
            color: #e0e0e0;
        }
        .nav-item.active {
            background: #8b7ab8;
            color: white;
        }
        .nav-item .icon {
            font-size: 20px;
        }
        .main-content {
            flex: 1;
            margin-left: 250px;
            padding: 20px;
        }
        h1 { color: #8b7ab8; margin-bottom: 10px; }
        .subtitle { color: #9e9eb0; margin-bottom: 20px; }
        .toolbar {
            background: #1a1a2e;
            border: 1px solid #2a2a3e;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
        }
        .toolbar select, .toolbar input {
            background: #0f0f1e;
            border: 1px solid #2a2a3e;
            color: #e0e0e0;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 14px;
        }
        .toolbar input { flex: 1; min-width: 200px; }
        .btn {
            background: #8b7ab8;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
        }
        .btn:hover { background: #6b5a98; }
        .btn-danger { background: #dc2626; }
        .btn-danger:hover { background: #b91c1c; }
        .affirmation-card {
            background: #1a1a2e;
            border: 1px solid #2a2a3e;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            transition: border-color 0.2s;
        }
        .affirmation-card.high-rated {
            border-color: #4ade80;
        }
        .affirmation-card.medium-rated {
            border-color: #fbbf24;
        }
        .affirmation-card.low-rated {
            border-color: #ef4444;
        }
        .quality-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            margin-right: 6px;
            margin-bottom: 4px;
        }
        .badge-high-usage {
            background: #fbbf24;
            color: #1a1a2e;
        }
        .badge-high-rated {
            background: #4ade80;
            color: #1a1a2e;
        }
        .badge-low-rated {
            background: #ef4444;
            color: white;
        }
        .badge-new {
            background: #8b7ab8;
            color: white;
        }
        .affirmation-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 10px;
        }
        .affirmation-text {
            font-size: 16px;
            color: #e0e0e0;
            margin-bottom: 10px;
            line-height: 1.5;
        }
        .affirmation-meta {
            display: flex;
            gap: 15px;
            color: #9e9eb0;
            font-size: 14px;
            margin-bottom: 10px;
        }
        .affirmation-tags {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-bottom: 10px;
        }
        .tag {
            background: #2a2a3e;
            color: #8b7ab8;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
        }
        .affirmation-actions {
            display: flex;
            gap: 10px;
        }
        .play-btn {
            background: #4ade80;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .play-btn:hover { background: #22c55e; }
        .play-btn:disabled {
            background: #6b6b7b;
            cursor: not-allowed;
        }
        .play-btn.playing {
            background: #ef4444;
        }
        .play-btn.playing:hover {
            background: #dc2626;
        }
        audio {
            display: none;
        }
        .rating {
            color: #fbbf24;
            font-weight: 600;
        }
        .modal {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        .modal.active { display: flex; }
        .modal-content {
            background: #1a1a2e;
            border: 1px solid #2a2a3e;
            border-radius: 12px;
            padding: 25px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .modal-header h2 { color: #8b7ab8; margin: 0; }
        .close-btn {
            background: none;
            border: none;
            color: #9e9eb0;
            font-size: 24px;
            cursor: pointer;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            color: #9e9eb0;
            margin-bottom: 5px;
            font-size: 14px;
        }
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            background: #0f0f1e;
            border: 1px solid #2a2a3e;
            color: #e0e0e0;
            padding: 10px;
            border-radius: 6px;
            font-size: 14px;
        }
        .form-group textarea {
            min-height: 100px;
            resize: vertical;
        }
        .form-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
        }
        .pagination {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
        }
        .pagination button {
            background: #2a2a3e;
            color: #e0e0e0;
            border: 1px solid #3a3a4e;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
        }
        .pagination button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .pagination .page-info {
            color: #9e9eb0;
            padding: 8px 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="sidebar">
            <h2>Admin Panel</h2>
            <a href="/admin" class="nav-item">
                <span class="icon">üìä</span>
                <span>Dashboard</span>
            </a>
            <a href="/admin/affirmations" class="nav-item active">
                <span class="icon">üìö</span>
                <span>Library</span>
            </a>
            <a href="/admin/users" class="nav-item">
                <span class="icon">üë•</span>
                <span>Users</span>
            </a>
            <a href="/admin/logs" class="nav-item">
                <span class="icon">üìä</span>
                <span>Logs</span>
            </a>
            <a href="/admin/templates" class="nav-item">
                <span class="icon">üé®</span>
                <span>Templates</span>
            </a>
            <a href="/admin/default-sessions" class="nav-item">
                <span class="icon">üéØ</span>
                <span>Defaults</span>
            </a>
            <a href="/admin/voice-settings" class="nav-item">
                <span class="icon">üé§</span>
                <span>Voice</span>
            </a>
            <a href="/admin/config" class="nav-item">
                <span class="icon">‚öôÔ∏è</span>
                <span>Config</span>
            </a>
        </div>

        <div class="main-content">
            <div style="margin-bottom: 20px;">
                <h1>üìö Affirmation Library</h1>
                <p class="subtitle">Manage your affirmation pool</p>
            </div>

            <div class="toolbar">
            <select id="goalFilter">
                <option value="">All Goals</option>
                <option value="sleep">Sleep</option>
                <option value="focus">Focus</option>
                <option value="calm">Calm</option>
                <option value="manifest">Manifest</option>
            </select>
            <select id="ratingFilter">
                <option value="">All Ratings</option>
                <option value="3.5">3.5+</option>
                <option value="4.0">4.0+</option>
                <option value="4.5">4.5+</option>
            </select>
            <input type="text" id="searchInput" placeholder="Search affirmations...">
            <select id="sortBy">
                <option value="useCount">Sort by Usage</option>
                <option value="rating">Sort by Rating</option>
                <option value="createdAt">Sort by Date</option>
            </select>
            <button class="btn" onclick="loadAffirmations()">üîç Filter</button>
            <button class="btn" onclick="openCreateModal()">+ Add New</button>
            <button class="btn" onclick="openBulkActions()" id="bulkActionsBtn" style="display: none;">Bulk Actions (<span id="selectedCount">0</span>)</button>
            <a href="#" onclick="exportAffirmations(); return false;" class="btn" style="text-decoration: none; display: inline-block;">üì• Export CSV</a>
        </div>

            <div id="affirmationsList"></div>
            <div class="pagination" id="pagination"></div>
        </div>
    </div>

    <!-- Create/Edit Modal -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">Add New Affirmation</h2>
                <button class="close-btn" onclick="closeModal()">&times;</button>
            </div>
            <form id="affirmationForm" onsubmit="saveAffirmation(event)">
                <div class="form-group">
                    <label>Affirmation Text *</label>
                    <textarea id="affirmationText" required></textarea>
                </div>
                <div class="form-group">
                    <label>Goal *</label>
                    <select id="affirmationGoal" required>
                        <option value="sleep">Sleep</option>
                        <option value="focus">Focus</option>
                        <option value="calm">Calm</option>
                        <option value="manifest">Manifest</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>ElevenLabs Voice *</label>
                    <select id="affirmationVoice" required>
                        <option value="neutral">Neutral (Mira - F)</option>
                        <option value="confident">Confident (Archer - M)</option>
                        <option value="premium1">Premium 1 (James - M)</option>
                        <option value="premium2">Premium 2 (Priyanka - F)</option>
                        <option value="premium3">Premium 3 (Rhea - F)</option>
                        <option value="premium4">Premium 4 (Chuck - M)</option>
                        <option value="premium5">Premium 5 (Zara - F)</option>
                        <option value="premium6">Premium 6 (Almee - F)</option>
                        <option value="premium7">Premium 7 (Kristen - F)</option>
                        <option value="premium8">Premium 8 (Drew - M)</option>
                    </select>
                    <small style="color: #9e9eb0; font-size: 12px; margin-top: 4px; display: block;">Audio will be generated immediately</small>
                </div>
                <div class="form-group">
                    <label>Tags (comma-separated)</label>
                    <input type="text" id="affirmationTags" placeholder="calm, peace, present">
                </div>
                <div class="form-group">
                    <label>Emotion</label>
                    <input type="text" id="affirmationEmotion" placeholder="peace, confidence, safety">
                </div>
                <div class="form-actions">
                    <button type="button" class="btn" onclick="closeModal()">Cancel</button>
                    <button type="submit" class="btn">Save</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        const API_BASE = window.location.origin;
        let currentPage = 1;
        let editingId = null;

        async function loadAffirmations() {
            const goal = document.getElementById('goalFilter').value;
            const minRating = document.getElementById('ratingFilter').value;
            const search = document.getElementById('searchInput').value;
            const sortBy = document.getElementById('sortBy').value;

            const params = new URLSearchParams({
                page: currentPage,
                limit: 50,
                sortBy,
                order: 'desc',
            });
            if (goal) params.append('goal', goal);
            if (minRating) params.append('minRating', minRating);
            if (search) params.append('search', search);

            try {
                const response = await fetch(`${API_BASE}/api/admin/affirmations?${params}`);
                const data = await response.json();
                displayAffirmations(data.affirmations, data.pagination);
            } catch (err) {
                alert(`Error: ${err.message}`);
            }
        }

        function getQualityBadges(aff) {
            const badges = [];
            const rating = aff.userRating || 0;
            const useCount = aff.useCount || 0;
            const createdAt = new Date(aff.createdAt);
            const daysSinceCreation = (Date.now() - createdAt.getTime()) / (1000 * 60 * 60 * 24);
            
            if (useCount > 50) {
                badges.push('<span class="quality-badge badge-high-usage">üî• High Usage</span>');
            }
            if (rating >= 4.5) {
                badges.push('<span class="quality-badge badge-high-rated">‚≠ê High Rated</span>');
            }
            if (rating > 0 && rating < 3.0) {
                badges.push('<span class="quality-badge badge-low-rated">‚ö†Ô∏è Low Rated</span>');
            }
            if (daysSinceCreation < 7) {
                badges.push('<span class="quality-badge badge-new">üÜï New</span>');
            }
            
            return badges.join('');
        }

        function getRatingClass(rating) {
            if (!rating || rating === 0) return '';
            if (rating >= 4.0) return 'high-rated';
            if (rating >= 3.0) return 'medium-rated';
            return 'low-rated';
        }

        function displayAffirmations(affirmations, pagination) {
            const list = document.getElementById('affirmationsList');
            
            if (affirmations.length === 0) {
                list.innerHTML = '<div style="text-align: center; padding: 40px; color: #9e9eb0;">No affirmations found</div>';
                return;
            }

            list.innerHTML = affirmations.map(aff => {
                const rating = aff.userRating || 0;
                const ratingClass = getRatingClass(rating);
                const badges = getQualityBadges(aff);
                
                return `
                <div class="affirmation-card ${ratingClass}">
                    <div style="display: flex; align-items: start; gap: 10px;">
                        <input type="checkbox" class="affirmation-checkbox" value="${aff.id}" onchange="updateSelection()" style="margin-top: 5px;">
                        <div style="flex: 1;">
                            ${badges ? `<div style="margin-bottom: 8px;">${badges}</div>` : ''}
                            <div class="affirmation-header">
                                <div class="affirmation-text">"${aff.text}"</div>
                                ${rating > 0 ? `<div class="rating" style="color: ${rating >= 4.0 ? '#4ade80' : rating >= 3.0 ? '#fbbf24' : '#ef4444'};">${rating.toFixed(1)}‚òÖ</div>` : '<div style="color: #6b6b7b;">No rating</div>'}
                            </div>
                            <div class="affirmation-meta">
                                <span>${aff.goal.charAt(0).toUpperCase() + aff.goal.slice(1)}</span>
                                ${aff.emotion ? `<span>‚Ä¢ ${aff.emotion}</span>` : ''}
                                <span>‚Ä¢ Used ${aff.useCount || 0}x</span>
                                ${rating > 0 ? `<span>‚Ä¢ Rated ${Math.floor((aff.useCount || 0) * 0.3)}x</span>` : ''}
                            </div>
                            ${aff.audioVersions && aff.audioVersions.length > 0 ? `
                                <div style="margin: 10px 0; padding: 10px; background: #0f0f1e; border-radius: 6px;">
                                    <div style="color: #8b7ab8; font-weight: 600; margin-bottom: 8px; font-size: 13px;">Voice Versions (${aff.audioVersions.length}):</div>
                                    <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                                        ${aff.audioVersions.map(audio => `
                                            <div style="display: flex; align-items: center; gap: 6px; background: #1a1a2e; padding: 6px 10px; border-radius: 4px; border: 1px solid #2a2a3e;">
                                                <span style="color: #9e9eb0; font-size: 12px;">${getVoiceName(audio.voiceId)}</span>
                                                <button class="play-btn" style="padding: 4px 8px; font-size: 11px;" id="play-btn-${audio.id}" onclick="playAffirmationAudio('${audio.id}', '${audio.audioUrl.replace(/'/g, "\\'")}')">‚ñ∂Ô∏è</button>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            ` : '<div style="color: #fbbf24; margin: 10px 0; font-size: 13px;">‚ö†Ô∏è No audio versions yet</div>'}
                            ${aff.tags && aff.tags.length > 0 ? `
                                <div class="affirmation-tags">
                                    ${aff.tags.map(tag => `<span class="tag">${tag}</span>`).join('')}
                                </div>
                            ` : ''}
                            <div class="affirmation-actions">
                                <button class="btn" onclick="openEditModal('${aff.id}')">‚úèÔ∏è Edit</button>
                                <button class="btn" onclick="openAddVoiceModal('${aff.id}')" style="background: #44B09E;">‚ûï Add Voice</button>
                                <button class="btn btn-danger" onclick="deleteAffirmation('${aff.id}')">üóëÔ∏è Delete</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            }).join('');

            // Pagination
            const paginationEl = document.getElementById('pagination');
            if (pagination.totalPages > 1) {
                paginationEl.innerHTML = `
                    <button onclick="changePage(${pagination.page - 1})" ${pagination.page === 1 ? 'disabled' : ''}>Previous</button>
                    <span class="page-info">Page ${pagination.page} of ${pagination.totalPages} (${pagination.total} total)</span>
                    <button onclick="changePage(${pagination.page + 1})" ${pagination.page === pagination.totalPages ? 'disabled' : ''}>Next</button>
                `;
            } else {
                paginationEl.innerHTML = '';
            }
        }

        function changePage(page) {
            currentPage = page;
            loadAffirmations();
        }

        function openCreateModal() {
            editingId = null;
            document.getElementById('modalTitle').textContent = 'Add New Affirmation';
            document.getElementById('affirmationForm').reset();
            document.getElementById('editModal').classList.add('active');
        }

        async function openEditModal(id) {
            try {
                // Fetch all affirmations and find the one we need
                const response = await fetch(`${API_BASE}/api/admin/affirmations?limit=1000`);
                const data = await response.json();
                const aff = data.affirmations.find(a => a.id === id);
                
                if (!aff) {
                    alert('Affirmation not found');
                    return;
                }

                editingId = id;
                document.getElementById('modalTitle').textContent = 'Edit Affirmation';
                document.getElementById('affirmationText').value = aff.text;
                document.getElementById('affirmationGoal').value = aff.goal;
                document.getElementById('affirmationVoice').value = aff.ttsVoiceId || 'neutral';
                document.getElementById('affirmationTags').value = Array.isArray(aff.tags) ? aff.tags.join(', ') : '';
                document.getElementById('affirmationEmotion').value = aff.emotion || '';
                document.getElementById('editModal').classList.add('active');
            } catch (err) {
                alert(`Error: ${err.message}`);
            }
        }

        function closeModal() {
            document.getElementById('editModal').classList.remove('active');
            editingId = null;
        }

        async function saveAffirmation(e) {
            e.preventDefault();
            const text = document.getElementById('affirmationText').value;
            const goal = document.getElementById('affirmationGoal').value;
            const voiceType = document.getElementById('affirmationVoice').value;
            const tagsStr = document.getElementById('affirmationTags').value;
            const emotion = document.getElementById('affirmationEmotion').value;

            const tags = tagsStr ? tagsStr.split(',').map(t => t.trim()).filter(t => t) : [];

            const url = editingId 
                ? `${API_BASE}/api/admin/affirmations/${editingId}`
                : `${API_BASE}/api/admin/affirmations`;
            
            const method = editingId ? 'PATCH' : 'POST';

            // Show loading state
            const submitBtn = e.target.querySelector('button[type="submit"]');
            const originalText = submitBtn.textContent;
            submitBtn.disabled = true;
            submitBtn.textContent = editingId ? 'Updating...' : 'Creating & Generating Audio...';

            try {
                const response = await fetch(url, {
                    method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ text, goal, voiceType, tags, emotion }),
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.message || 'Failed to save');
                }

                const result = await response.json();
                if (result.audioGenerated) {
                    alert('‚úÖ Affirmation created and audio generated successfully!');
                } else if (result.audioError) {
                    alert(`‚ö†Ô∏è Affirmation created but audio generation failed: ${result.audioError}`);
                }

                closeModal();
                loadAffirmations();
            } catch (err) {
                alert(`Error: ${err.message}`);
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = originalText;
            }
        }

        async function deleteAffirmation(id) {
            if (!confirm('Are you sure you want to delete this affirmation?')) return;

            try {
                const response = await fetch(`${API_BASE}/api/admin/affirmations/${id}`, {
                    method: 'DELETE',
                });

                if (!response.ok) {
                    const error = await response.json();
                    if (error.error === 'IN_USE') {
                        alert(`Cannot delete: ${error.message}\nUsed in templates: ${error.templates.map(t => t.title).join(', ')}`);
                        return;
                    }
                    throw new Error(error.message || 'Failed to delete');
                }

                loadAffirmations();
            } catch (err) {
                alert(`Error: ${err.message}`);
            }
        }

        let selectedIds = new Set();

        function updateSelection() {
            const checkboxes = document.querySelectorAll('.affirmation-checkbox:checked');
            selectedIds = new Set(Array.from(checkboxes).map(cb => cb.value));
            const count = selectedIds.size;
            const btn = document.getElementById('bulkActionsBtn');
            const countSpan = document.getElementById('selectedCount');
            if (count > 0) {
                btn.style.display = 'inline-block';
                countSpan.textContent = count;
            } else {
                btn.style.display = 'none';
            }
        }

        function openBulkActions() {
            if (selectedIds.size === 0) {
                alert('No affirmations selected');
                return;
            }

            // Create modal for bulk actions
            const modal = document.createElement('div');
            modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 10000; display: flex; align-items: center; justify-content: center;';
            modal.innerHTML = `
                <div style="background: #1a1a2e; border: 1px solid #2a2a3e; border-radius: 8px; padding: 25px; max-width: 500px; width: 90%;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h2 style="color: #8b7ab8; margin: 0;">Bulk Actions (${selectedIds.size} selected)</h2>
                        <button onclick="this.closest('div[style*=\"position: fixed\"]').remove()" style="background: none; border: none; color: #9e9eb0; font-size: 24px; cursor: pointer;">&times;</button>
                    </div>
                    <div style="display: flex; flex-direction: column; gap: 10px;">
                        <button class="btn btn-danger" onclick="bulkDelete(); this.closest('div[style*=\"position: fixed\"]').remove();" style="width: 100%;">üóëÔ∏è Delete Selected</button>
                        <button class="btn" onclick="bulkUpdateGoal(); this.closest('div[style*=\"position: fixed\"]').remove();" style="width: 100%;">üéØ Update Goal</button>
                        <button class="btn" onclick="bulkAddTags(); this.closest('div[style*=\"position: fixed\"]').remove();" style="width: 100%;">üè∑Ô∏è Add Tags</button>
                        <button class="btn" onclick="bulkRegenerateAudio(); this.closest('div[style*=\"position: fixed\"]').remove();" style="width: 100%;">üîä Regenerate Audio</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        async function bulkDelete() {
            if (!confirm(`Delete ${selectedIds.size} affirmation(s)?`)) return;
            
            try {
                const response = await fetch(`${API_BASE}/api/admin/affirmations/bulk-delete`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ ids: Array.from(selectedIds) }),
                });

                if (!response.ok) {
                    const error = await response.json();
                    if (error.error === 'IN_USE') {
                        alert(`Cannot delete: ${error.message}\nUsed IDs: ${error.usedIds.join(', ')}`);
                        return;
                    }
                    throw new Error(error.message || 'Failed to delete');
                }

                const result = await response.json();
                alert(`Deleted ${result.deleted} affirmation(s)`);
                selectedIds.clear();
                updateSelection();
                loadAffirmations();
            } catch (err) {
                alert(`Error: ${err.message}`);
            }
        }

        async function bulkUpdateGoal() {
            const goal = prompt('Enter new goal (sleep/focus/calm/manifest):');
            if (!goal || !['sleep', 'focus', 'calm', 'manifest'].includes(goal)) {
                alert('Invalid goal');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/api/admin/affirmations/bulk-update`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ ids: Array.from(selectedIds), updates: { goal } }),
                });

                if (!response.ok) throw new Error('Failed to update');
                const result = await response.json();
                alert(`Updated ${result.updated} affirmation(s)`);
                selectedIds.clear();
                updateSelection();
                loadAffirmations();
            } catch (err) {
                alert(`Error: ${err.message}`);
            }
        }

        async function bulkAddTags() {
            const tagsInput = prompt('Enter tags to add (comma-separated):');
            if (!tagsInput) return;

            const tags = tagsInput.split(',').map(t => t.trim()).filter(t => t);
            if (tags.length === 0) {
                alert('No valid tags provided');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/api/admin/affirmations/bulk-update`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ ids: Array.from(selectedIds), updates: { tags } }),
                });

                if (!response.ok) throw new Error('Failed to update');
                const result = await response.json();
                alert(`‚úÖ Added tags to ${result.updated} affirmation(s): ${tags.join(', ')}`);
                selectedIds.clear();
                updateSelection();
                loadAffirmations();
            } catch (err) {
                alert(`Error: ${err.message}`);
            }
        }

        async function bulkRegenerateAudio() {
            if (!confirm(`Regenerate audio for ${selectedIds.size} affirmation(s)?\n\nThis will invalidate cached audio. New audio will be generated on next use.`)) return;

            try {
                const response = await fetch(`${API_BASE}/api/admin/affirmations/bulk-regenerate-audio`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ ids: Array.from(selectedIds) }),
                });

                if (!response.ok) throw new Error('Failed to regenerate');
                const result = await response.json();
                alert(`‚úÖ ${result.message}`);
                selectedIds.clear();
                updateSelection();
            } catch (err) {
                alert(`Error: ${err.message}`);
            }
        }

        // Load on page load
        loadAffirmations();

        function exportAffirmations() {
            const goal = document.getElementById('goalFilter').value;
            const params = new URLSearchParams({ type: 'affirmations' });
            if (goal) params.append('goal', goal);
            window.location.href = `${API_BASE}/api/admin/export?${params}`;
        }

        // Filter on Enter key
        document.getElementById('searchInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') loadAffirmations();
        });

        // Voice name mapping
        function getVoiceName(voiceId) {
            const voiceNames = {
                'neutral': 'Mira (F)',
                'confident': 'Archer (M)',
                'premium1': 'James (M)',
                'premium2': 'Priyanka (F)',
                'premium3': 'Rhea (F)',
                'premium4': 'Chuck (M)',
                'premium5': 'Zara (F)',
                'premium6': 'Almee (F)',
                'premium7': 'Kristen (F)',
                'premium8': 'Drew (M)',
            };
            return voiceNames[voiceId] || voiceId;
        }

        // Audio playback state
        let currentlyPlaying = null;
        const audioElements = new Map(); // Store audio elements by ID

        function playAffirmationAudio(audioId, audioUrl) {
            // Create audio element if it doesn't exist
            if (!audioElements.has(audioId)) {
                const audio = document.createElement('audio');
                audio.src = `${API_BASE}${audioUrl}`;
                audio.onended = () => stopAffirmationAudio(audioId);
                audioElements.set(audioId, audio);
                document.body.appendChild(audio);
            }

            const audio = audioElements.get(audioId);
            const playBtn = document.getElementById(`play-btn-${audioId}`);
            
            if (!audio || !playBtn) {
                alert('Audio not available');
                return;
            }

            // Stop any currently playing audio
            if (currentlyPlaying && currentlyPlaying !== audioId) {
                stopAffirmationAudio(currentlyPlaying);
            }

            if (audio.paused) {
                // Start playing
                audio.play().then(() => {
                    playBtn.classList.add('playing');
                    playBtn.innerHTML = '‚è∏Ô∏è';
                    currentlyPlaying = audioId;
                }).catch(err => {
                    console.error('Playback error:', err);
                    alert('Failed to play audio: ' + err.message);
                });
            } else {
                // Stop playing
                stopAffirmationAudio(audioId);
            }
        }

        function stopAffirmationAudio(audioId) {
            const audio = audioElements.get(audioId);
            const playBtn = document.getElementById(`play-btn-${audioId}`);
            
            if (audio) {
                audio.pause();
                audio.currentTime = 0;
            }
            
            if (playBtn) {
                playBtn.classList.remove('playing');
                playBtn.innerHTML = '‚ñ∂Ô∏è';
            }
            
            if (currentlyPlaying === audioId) {
                currentlyPlaying = null;
            }
        }

        function openAddVoiceModal(affirmationId) {
            // Create modal for adding a new voice version
            const modal = document.createElement('div');
            modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 10000; display: flex; align-items: center; justify-content: center;';
            modal.innerHTML = `
                <div style="background: #1a1a2e; border: 1px solid #2a2a3e; border-radius: 8px; padding: 25px; max-width: 500px; width: 90%;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h2 style="color: #8b7ab8; margin: 0;">Add Voice Version</h2>
                        <button onclick="this.closest('div[style*=\"position: fixed\"]').remove()" style="background: none; border: none; color: #9e9eb0; font-size: 24px; cursor: pointer;">&times;</button>
                    </div>
                    <form id="addVoiceForm" onsubmit="addVoiceVersion(event, '${affirmationId}'); return false;">
                        <div class="form-group">
                            <label>ElevenLabs Voice *</label>
                            <select id="newVoiceType" required style="width: 100%; background: #0f0f1e; border: 1px solid #2a2a3e; color: #e0e0e0; padding: 10px; border-radius: 6px;">
                                <option value="neutral">Neutral (Mira - F)</option>
                                <option value="confident">Confident (Archer - M)</option>
                                <option value="premium1">Premium 1 (James - M)</option>
                                <option value="premium2">Premium 2 (Priyanka - F)</option>
                                <option value="premium3">Premium 3 (Rhea - F)</option>
                                <option value="premium4">Premium 4 (Chuck - M)</option>
                                <option value="premium5">Premium 5 (Zara - F)</option>
                                <option value="premium6">Premium 6 (Almee - F)</option>
                                <option value="premium7">Premium 7 (Kristen - F)</option>
                                <option value="premium8">Premium 8 (Drew - M)</option>
                            </select>
                        </div>
                        <div class="form-actions">
                            <button type="button" class="btn" onclick="this.closest('div[style*=\"position: fixed\"]').remove()">Cancel</button>
                            <button type="submit" class="btn">Generate Audio</button>
                        </div>
                    </form>
                </div>
            `;
            document.body.appendChild(modal);
        }

        async function addVoiceVersion(e, affirmationId) {
            e.preventDefault();
            const voiceType = document.getElementById('newVoiceType').value;

            // Get affirmation text and goal
            const response = await fetch(`${API_BASE}/api/admin/affirmations?limit=1000`);
            const data = await response.json();
            const aff = data.affirmations.find(a => a.id === affirmationId);
            
            if (!aff) {
                alert('Affirmation not found');
                return;
            }

            // Generate audio for this voice version
            try {
                const generateResponse = await fetch(`${API_BASE}/api/admin/affirmations/${affirmationId}/generate-audio`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ voiceType, pace }),
                });

                if (!generateResponse.ok) {
                    const error = await generateResponse.json();
                    throw new Error(error.message || 'Failed to generate audio');
                }

                const result = await generateResponse.json();
                if (result.audioGenerated) {
                    alert('‚úÖ Audio generated successfully!');
                    document.querySelector('div[style*="position: fixed"]')?.remove();
                    loadAffirmations();
                } else if (result.audioError) {
                    alert(`‚ö†Ô∏è Audio generation failed: ${result.audioError}`);
                }
            } catch (err) {
                alert(`Error: ${err.message}`);
            }
        }
    </script>
</body>
</html>


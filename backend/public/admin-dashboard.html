<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - AffirmBeats</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #0f0f1e;
            color: #e0e0e0;
            padding: 20px;
            line-height: 1.6;
        }

        .container {
            display: flex;
            max-width: 100%;
            margin: 0;
            min-height: 100vh;
        }

        .sidebar {
            width: 250px;
            background: #1a1a2e;
            border-right: 1px solid #2a2a3e;
            padding: 20px;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
        }

        .sidebar h2 {
            color: #8b7ab8;
            font-size: 1.5rem;
            margin-bottom: 30px;
            padding-bottom: 15px;
            border-bottom: 1px solid #2a2a3e;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 15px;
            margin-bottom: 8px;
            border-radius: 8px;
            text-decoration: none;
            color: #9e9eb0;
            transition: all 0.2s;
        }

        .nav-item:hover {
            background: #2a2a3e;
            color: #e0e0e0;
        }

        .nav-item.active {
            background: #8b7ab8;
            color: white;
        }

        .nav-item .icon {
            font-size: 20px;
        }

        .main-content {
            flex: 1;
            margin-left: 250px;
            padding: 20px;
        }

        h1 {
            color: #8b7ab8;
            margin-bottom: 10px;
            font-size: 2.5rem;
        }

        .subtitle {
            color: #9e9eb0;
            margin-bottom: 30px;
        }

        .refresh-btn {
            background: #8b7ab8;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            margin-bottom: 20px;
        }

        .refresh-btn:hover {
            background: #6b5a98;
        }

        .refresh-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .card {
            background: #1a1a2e;
            border: 1px solid #2a2a3e;
            border-radius: 12px;
            padding: 20px;
        }

        .card h2 {
            color: #8b7ab8;
            font-size: 1.3rem;
            margin-bottom: 15px;
            border-bottom: 1px solid #2a2a3e;
            padding-bottom: 10px;
        }

        .stat-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #2a2a3e;
        }

        .stat-row:last-child {
            border-bottom: none;
        }

        .stat-label {
            color: #9e9eb0;
        }

        .stat-value {
            color: #e0e0e0;
            font-weight: 600;
        }

        .stat-value.positive {
            color: #4ade80;
        }

        .stat-value.negative {
            color: #f87171;
        }

        .stat-value.warning {
            color: #fbbf24;
        }

        .match-type {
            margin: 10px 0;
            padding: 10px;
            background: #0f0f1e;
            border-radius: 6px;
        }

        .match-type-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }

        .progress-bar {
            height: 8px;
            background: #2a2a3e;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 5px;
        }

        .progress-fill {
            height: 100%;
            background: #8b7ab8;
            transition: width 0.3s;
        }

        .alert {
            padding: 12px;
            border-radius: 6px;
            margin: 8px 0;
            border-left: 4px solid;
        }

        .alert.warning {
            background: #3f2e1e;
            border-color: #fbbf24;
            color: #fbbf24;
        }

        .alert.success {
            background: #1e3f2e;
            border-color: #4ade80;
            color: #4ade80;
        }

        .alert.info {
            background: #1e2e3f;
            border-color: #60a5fa;
            color: #60a5fa;
        }

        .table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        .table th,
        .table td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #2a2a3e;
        }

        .table th {
            color: #8b7ab8;
            font-weight: 600;
        }

        .table td {
            color: #e0e0e0;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #9e9eb0;
        }

        .error {
            background: #3f1e1e;
            border: 1px solid #f87171;
            color: #f87171;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }

        .timestamp {
            color: #6b6b7b;
            font-size: 0.9rem;
            margin-top: 20px;
            text-align: center;
        }

        .goal-stats {
            margin: 5px 0;
            padding-left: 15px;
        }

        .export-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .export-btn {
            background: #2a2a3e;
            color: #8b7ab8;
            border: 1px solid #3a3a4e;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
            font-size: 14px;
        }

        .export-btn:hover {
            background: #3a3a4e;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="sidebar">
            <h2>Admin Panel</h2>
            <a href="/admin" class="nav-item active">
                <span class="icon">üìä</span>
                <span>Dashboard</span>
            </a>
            <a href="/admin/affirmations" class="nav-item">
                <span class="icon">üìö</span>
                <span>Library</span>
            </a>
            <a href="/admin/users" class="nav-item">
                <span class="icon">üë•</span>
                <span>Users</span>
            </a>
            <a href="/admin/logs" class="nav-item">
                <span class="icon">üìä</span>
                <span>Logs</span>
            </a>
            <a href="/admin/templates" class="nav-item">
                <span class="icon">üé®</span>
                <span>Templates</span>
            </a>
            <a href="/admin/default-sessions" class="nav-item">
                <span class="icon">üéØ</span>
                <span>Defaults</span>
            </a>
            <a href="/admin/voice-settings" class="nav-item">
                <span class="icon">üé§</span>
                <span>Voice</span>
            </a>
            <a href="/admin/config" class="nav-item">
                <span class="icon">‚öôÔ∏è</span>
                <span>Config</span>
            </a>
        </div>

        <div class="main-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <div>
                    <h1>üìä Admin Dashboard</h1>
                    <p class="subtitle">Real-time monitoring and analytics</p>
                </div>
            </div>
            
            <button class="refresh-btn" onclick="loadDashboard()" id="refreshBtn">üîÑ Refresh</button>
        
        <div id="loading" class="loading">Loading dashboard data...</div>
        <div id="error" class="error" style="display: none;"></div>
        <div id="dashboard" style="display: none;"></div>
    </div>

    <script>
        const API_BASE = window.location.origin;

        async function loadDashboard() {
            const refreshBtn = document.getElementById('refreshBtn');
            const loading = document.getElementById('loading');
            const error = document.getElementById('error');
            const dashboard = document.getElementById('dashboard');

            refreshBtn.disabled = true;
            loading.style.display = 'block';
            error.style.display = 'none';
            dashboard.style.display = 'none';

            try {
                const response = await fetch(`${API_BASE}/api/admin/dashboard`);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                const data = await response.json();
                displayDashboard(data);
            } catch (err) {
                error.textContent = `Error loading dashboard: ${err.message}`;
                error.style.display = 'block';
            } finally {
                loading.style.display = 'none';
                refreshBtn.disabled = false;
            }
        }

        function displayDashboard(data) {
            const dashboard = document.getElementById('dashboard');
            // Store recent errors globally for modal
            recentErrorsData = data.realTimeStats.recentErrors || [];
            dashboard.innerHTML = `
                <div class="grid">
                    ${createRealTimeStatsCard(data.realTimeStats)}
                    ${createCostBreakdownCard(data.costBreakdown)}
                    ${createLibraryHealthCard(data.libraryHealth)}
                    ${createQualityMetricsCard(data.qualityMetrics)}
                    ${createUserMetricsCard(data.userMetrics)}
                    ${createRecentActivityCard(data.recentActivity)}
                    ${createAlertsCard(data.alerts)}
                </div>
                <div class="timestamp">Last updated: ${new Date().toLocaleString()}</div>
            `;
            dashboard.style.display = 'block';
        }

        function formatTrend(change) {
            if (change === 0 || change === undefined || isNaN(change)) return '';
            const arrow = change >= 0 ? '‚Üë' : '‚Üì';
            const color = change >= 0 ? 'positive' : 'negative';
            return `<span class="${color}" style="font-size: 0.9em; margin-left: 5px;">${arrow} ${Math.abs(change).toFixed(1)}%</span>`;
        }

        function createRealTimeStatsCard(stats) {
            const revenueChangeClass = stats.revenueChange >= 0 ? 'positive' : 'negative';
            const errorRateClass = stats.errorRate < 0.01 ? 'positive' : stats.errorRate < 0.02 ? 'warning' : 'negative';
            const errorRateChangeClass = stats.errorRateChange >= 0 ? 'negative' : 'positive';
            
            // Calculate total errors for breakdown display
            const totalErrors = Object.values(stats.errorBreakdown || {}).reduce((sum, count) => sum + count, 0);
            const errorBreakdownHtml = totalErrors > 0 ? `
                <div style="margin-top: 10px; padding: 10px; background: #1a1a2e; border-radius: 6px; font-size: 0.85em;">
                    <strong style="color: #8b7ab8;">Error Breakdown:</strong>
                    <div style="margin-top: 5px; display: flex; gap: 10px; flex-wrap: wrap;">
                        ${Object.entries(stats.errorBreakdown || {}).filter(([_, count]) => count > 0).map(([type, count]) => 
                            `<span style="color: ${type.startsWith('4') ? '#fbbf24' : type.startsWith('5') ? '#ef4444' : '#9e9eb0'};">
                                ${type}: ${count}
                            </span>`
                        ).join('')}
                    </div>
                    ${stats.recentErrors && stats.recentErrors.length > 0 ? `
                        <button onclick="showErrorDetails()" style="margin-top: 8px; background: #2a2a3e; color: #8b7ab8; border: 1px solid #3a3a4e; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 0.9em;">
                            View Last ${stats.recentErrors.length} Errors
                        </button>
                    ` : ''}
                </div>
            ` : '';
            
            return `
                <div class="card">
                    <h2>üìä Live Stats (Last 24h)</h2>
                    <div class="stat-row">
                        <span class="stat-label">üî¥ Active Users</span>
                        <span class="stat-value">
                            ${formatNumber(stats.activeUsers)}
                            ${formatTrend(stats.activeUsersChange)}
                        </span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">üí∞ Revenue Today</span>
                        <span class="stat-value ${revenueChangeClass}">
                            ${formatCurrency(stats.revenueToday)} 
                            ${formatTrend(stats.revenueChange)}
                        </span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">‚ö° Sessions Generated</span>
                        <span class="stat-value">
                            ${formatNumber(stats.sessionsGenerated)}
                            ${formatTrend(stats.sessionsChange)}
                        </span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">üí∏ API Cost Today</span>
                        <span class="stat-value">
                            ${formatCurrency(stats.apiCostToday)}
                            ${formatTrend(stats.apiCostChange)}
                        </span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">üêõ Error Rate</span>
                        <span class="stat-value ${errorRateClass}">
                            ${(stats.errorRate * 100).toFixed(2)}% 
                            ${stats.errorRate < 0.01 ? '‚úÖ' : stats.errorRate < 0.02 ? '‚ö†Ô∏è' : 'üö®'}
                            ${formatTrend(stats.errorRateChange)}
                        </span>
                    </div>
                    ${errorBreakdownHtml}
                    <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #2a2a3e;">
                        <div style="color: #8b7ab8; font-weight: 600; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center;">
                            <span>Error Rate Trend (Last 7 Days)</span>
                            <select id="errorTrendDays" onchange="loadErrorTrend()" style="background: #0f0f1e; border: 1px solid #2a2a3e; color: #e0e0e0; padding: 4px 8px; border-radius: 4px; font-size: 0.85em;">
                                <option value="7">7 Days</option>
                                <option value="14">14 Days</option>
                                <option value="30">30 Days</option>
                            </select>
                        </div>
                        <div id="errorTrendChart" style="height: 150px; background: #0f0f1e; border-radius: 6px; padding: 10px; position: relative;">
                            <div style="color: #9e9eb0; text-align: center; padding: 40px; font-size: 0.9em;">Loading trend data...</div>
                        </div>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">‚≠ê Avg Rating</span>
                        <span class="stat-value">${stats.avgRating > 0 ? stats.avgRating.toFixed(1) : 'N/A'}/5</span>
                    </div>
                </div>
            `;
        }

        // Store recent errors globally for modal
        let recentErrorsData = [];

        function showErrorDetails() {
            const errors = recentErrorsData;
            if (!errors || errors.length === 0) {
                alert('No recent errors to display');
                return;
            }

            const modal = document.createElement('div');
            modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 10000; display: flex; align-items: center; justify-content: center;';
            modal.innerHTML = `
                <div style="background: #1a1a2e; border: 1px solid #2a2a3e; border-radius: 8px; padding: 20px; max-width: 800px; max-height: 80vh; overflow-y: auto; width: 90%;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h2 style="color: #8b7ab8; margin: 0;">Recent Errors (Last 10)</h2>
                        <button onclick="this.closest('div[style*=\"position: fixed\"]').remove()" style="background: none; border: none; color: #9e9eb0; font-size: 24px; cursor: pointer;">&times;</button>
                    </div>
                    <table class="table" style="width: 100%;">
                        <thead>
                            <tr>
                                <th>Time</th>
                                <th>Method</th>
                                <th>Path</th>
                                <th>Status</th>
                                <th>Error</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${errors.map(err => `
                                <tr>
                                    <td>${new Date(err.timestamp).toLocaleString()}</td>
                                    <td>${err.method}</td>
                                    <td style="font-family: monospace; font-size: 0.85em;">${err.path}</td>
                                    <td style="color: ${err.status.startsWith('4') ? '#fbbf24' : err.status.startsWith('5') ? '#ef4444' : '#9e9eb0'};">${err.status}</td>
                                    <td style="font-family: monospace; font-size: 0.85em; color: #9e9eb0;">${err.error}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function createCostBreakdownCard(breakdown) {
            const exact = breakdown.matchTypeDistribution.exact;
            const pooled = breakdown.matchTypeDistribution.pooled;
            const generated = breakdown.matchTypeDistribution.generated;
            
            // Confidence distribution visualization
            const confDist = breakdown.confidenceDistribution || {};
            const confDistHtml = Object.entries(confDist).map(([bucket, counts]) => {
                const total = (counts.exact || 0) + (counts.pooled || 0);
                if (total === 0) return '';
                const exactCount = counts.exact || 0;
                const pooledCount = counts.pooled || 0;
                const exactPercent = total > 0 ? (exactCount / total) * 100 : 0;
                const pooledPercent = total > 0 ? (pooledCount / total) * 100 : 0;
                
                return `
                    <div style="margin-bottom: 8px;">
                        <div style="display: flex; justify-content: space-between; font-size: 0.85em; color: #9e9eb0; margin-bottom: 4px;">
                            <span>${bucket}</span>
                            <span>${total} sessions</span>
                        </div>
                        <div style="display: flex; height: 20px; border-radius: 4px; overflow: hidden;">
                            ${exactPercent > 0 ? `<div style="background: #4ade80; width: ${exactPercent}%; display: flex; align-items: center; justify-content: center; font-size: 10px; color: #1a1a2e; font-weight: 600;">${exactCount}</div>` : ''}
                            ${pooledPercent > 0 ? `<div style="background: #8b7ab8; width: ${pooledPercent}%; display: flex; align-items: center; justify-content: center; font-size: 10px; color: white; font-weight: 600;">${pooledCount}</div>` : ''}
                        </div>
                    </div>
                `;
            }).filter(Boolean).join('');

            // Template coverage
            const coverage = breakdown.templateCoverage || { matched: 0, unmatched: 0, coveragePercent: 0 };
            const coverageHtml = coverage.matched + coverage.unmatched > 0 ? `
                <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #2a2a3e;">
                    <div style="color: #8b7ab8; font-weight: 600; margin-bottom: 8px;">Template Coverage</div>
                    <div style="display: flex; justify-content: space-between; font-size: 0.9em; margin-bottom: 8px;">
                        <span style="color: #4ade80;">‚úÖ Matched: ${coverage.matched}</span>
                        <span style="color: ${coverage.coveragePercent >= 70 ? '#4ade80' : coverage.coveragePercent >= 50 ? '#fbbf24' : '#ef4444'};">${coverage.coveragePercent.toFixed(0)}%</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; font-size: 0.9em; margin-bottom: 8px;">
                        <span style="color: #fbbf24;">‚ö†Ô∏è Unmatched: ${coverage.unmatched}</span>
                        <span style="color: #9e9eb0;">${coverage.unmatched > 0 ? `‚Üí Create ${Math.min(coverage.unmatched, 5)} templates` : ''}</span>
                    </div>
                    <div style="background: #0f0f1e; height: 8px; border-radius: 4px; overflow: hidden; margin-top: 8px;">
                        <div style="background: ${coverage.coveragePercent >= 70 ? '#4ade80' : coverage.coveragePercent >= 50 ? '#fbbf24' : '#ef4444'}; height: 100%; width: ${coverage.coveragePercent}%; transition: width 0.3s;"></div>
                    </div>
                </div>
            ` : '';

            return `
                <div class="card">
                    <h2>üí∞ Cost Breakdown (This Month)</h2>
                    <div class="match-type">
                        <div class="match-type-label">
                            <span>Exact Match</span>
                            <span>${exact.percent.toFixed(0)}% (${exact.count}) - ${formatCurrency(exact.cost)}</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${exact.percent}%"></div>
                        </div>
                    </div>
                    <div class="match-type">
                        <div class="match-type-label">
                            <span>Pooled</span>
                            <span>${pooled.percent.toFixed(0)}% (${pooled.count}) - ${formatCurrency(pooled.cost)}</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${pooled.percent}%"></div>
                        </div>
                    </div>
                    <div class="match-type">
                        <div class="match-type-label">
                            <span>Generated</span>
                            <span>${generated.percent.toFixed(0)}% (${generated.count}) - ${formatCurrency(generated.cost)}</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${generated.percent}%"></div>
                        </div>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">Total Spent</span>
                        <span class="stat-value">${formatCurrency(breakdown.totalSpent)}</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">Projected Monthly</span>
                        <span class="stat-value">${formatCurrency(breakdown.projectedMonthly)}</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">Savings vs Full Gen</span>
                        <span class="stat-value positive">
                            ${formatCurrency(breakdown.savings)} (${breakdown.savingsPercent.toFixed(0)}% reduction) ‚úÖ
                        </span>
                    </div>
                    ${Object.keys(confDist).some(bucket => (confDist[bucket].exact || 0) + (confDist[bucket].pooled || 0) > 0) ? `
                        <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #2a2a3e;">
                            <div style="color: #8b7ab8; font-weight: 600; margin-bottom: 10px;">Confidence Score Distribution</div>
                            <div style="font-size: 0.85em; color: #9e9eb0; margin-bottom: 8px;">
                                <span style="color: #4ade80;">Green = Exact</span> | 
                                <span style="color: #8b7ab8;">Purple = Pooled</span>
                            </div>
                            ${confDistHtml}
                        </div>
                    ` : ''}
                    ${coverageHtml}
                    <div class="export-buttons">
                        <a href="${API_BASE}/api/admin/export?type=costs" class="export-btn" download>üì• Export Costs (CSV)</a>
                    </div>
                </div>
            `;
        }

        function createLibraryHealthCard(health) {
            const goalStats = health.affirmationsByGoal.map(g => 
                `<div class="goal-stats">‚îú‚îÄ ${g.goal.charAt(0).toUpperCase() + g.goal.slice(1)}: ${formatNumber(g.count)} (avg rating: ${g.avgRating > 0 ? g.avgRating.toFixed(1) : 'N/A'})</div>`
            ).join('');

            return `
                <div class="card">
                    <h2>üìö Library Stats</h2>
                    <div class="stat-row">
                        <span class="stat-label">Total Affirmations</span>
                        <span class="stat-value">${formatNumber(health.totalAffirmations)}</span>
                    </div>
                    ${goalStats}
                    <div class="stat-row">
                        <span class="stat-label">Templates</span>
                        <span class="stat-value">${formatNumber(health.totalTemplates)}</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">Coverage</span>
                        <span class="stat-value">${health.coverage.toFixed(0)}% of user intents matched</span>
                    </div>
                    ${health.lowRatedCount > 0 ? `
                        <div class="alert warning">
                            ‚ö†Ô∏è Low-rated affirmations: ${health.lowRatedCount} need review
                        </div>
                    ` : ''}
                </div>
            `;
        }

        function createQualityMetricsCard(metrics) {
            return `
                <div class="card">
                    <h2>‚≠ê Quality Comparison</h2>
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Match Type</th>
                                <th>Rating</th>
                                <th>Replay %</th>
                                <th>Complete %</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>Exact Match</td>
                                <td>${metrics.exact.rating > 0 ? metrics.exact.rating.toFixed(1) : 'N/A'}</td>
                                <td>${metrics.exact.replayPercent.toFixed(0)}%</td>
                                <td>${metrics.exact.completePercent.toFixed(0)}%</td>
                            </tr>
                            <tr>
                                <td>Pooled</td>
                                <td>${metrics.pooled.rating > 0 ? metrics.pooled.rating.toFixed(1) : 'N/A'}</td>
                                <td>${metrics.pooled.replayPercent.toFixed(0)}%</td>
                                <td>${metrics.pooled.completePercent.toFixed(0)}%</td>
                            </tr>
                            <tr>
                                <td>Generated</td>
                                <td>${metrics.generated.rating > 0 ? metrics.generated.rating.toFixed(1) : 'N/A'}</td>
                                <td>${metrics.generated.replayPercent.toFixed(0)}%</td>
                                <td>${metrics.generated.completePercent.toFixed(0)}%</td>
                            </tr>
                        </tbody>
                    </table>
                    <div style="margin-top: 10px; color: #4ade80; font-size: 0.9rem;">
                        ‚úÖ Quality parity maintained across all types
                    </div>
                </div>
            `;
        }

        function createUserMetricsCard(metrics) {
            return `
                <div class="card">
                    <h2>üë• User Health</h2>
                    <div class="stat-row">
                        <span class="stat-label">Total Users</span>
                        <span class="stat-value">${formatNumber(metrics.totalUsers)}</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">Free Users</span>
                        <span class="stat-value">${formatNumber(metrics.freeUsers)} (${((metrics.freeUsers / Math.max(metrics.totalUsers, 1)) * 100).toFixed(0)}%)</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">Pro Users</span>
                        <span class="stat-value">${formatNumber(metrics.proUsers)} (${((metrics.proUsers / Math.max(metrics.totalUsers, 1)) * 100).toFixed(0)}%)</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">Conversion Rate</span>
                        <span class="stat-value">${metrics.conversionRate.toFixed(1)}%</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">MRR</span>
                        <span class="stat-value">${formatCurrency(metrics.mrr)}</span>
                    </div>
                    <div class="export-buttons">
                        <a href="${API_BASE}/api/admin/export?type=users" class="export-btn" download>üì• Export Users (CSV)</a>
                    </div>
                </div>
            `;
        }

        function createRecentActivityCard(activity) {
            if (activity.length === 0) {
                return `
                    <div class="card">
                        <h2>üìã Recent Generations</h2>
                        <div style="color: #9e9eb0; padding: 20px; text-align: center;">
                            No recent activity
                        </div>
                    </div>
                `;
            }

            const rows = activity.slice(0, 10).map(a => {
                const timeAgo = getTimeAgo(new Date(a.createdAt));
                return `
                    <tr>
                        <td>${timeAgo}</td>
                        <td>${a.userId.substring(0, 8)}</td>
                        <td>${a.goal}</td>
                        <td>${a.matchType}</td>
                    </tr>
                `;
            }).join('');

            return `
                <div class="card">
                    <h2>üìã Recent Generations</h2>
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Time</th>
                                <th>User</th>
                                <th>Goal</th>
                                <th>Type</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${rows}
                        </tbody>
                    </table>
                    <div class="export-buttons">
                        <a href="${API_BASE}/api/admin/export?type=sessions" class="export-btn" download>üì• Export Sessions (CSV)</a>
                    </div>
                </div>
            `;
        }

        function createAlertsCard(alerts) {
            if (alerts.length === 0) {
                return `
                    <div class="card">
                        <h2>üö® Alerts</h2>
                        <div style="color: #4ade80; padding: 10px;">
                            ‚úÖ All systems operational
                        </div>
                    </div>
                `;
            }

            const alertHtml = alerts.map(a => {
                const icon = a.type === 'warning' ? '‚ö†Ô∏è' : a.type === 'success' ? '‚úÖ' : 'üí°';
                return `<div class="alert ${a.type}">${icon} ${a.message}</div>`;
            }).join('');

            return `
                <div class="card">
                    <h2>üö® Alerts</h2>
                    ${alertHtml}
                </div>
            `;
        }

        function formatCurrency(amount) {
            return `$${amount.toFixed(2)}`;
        }

        function formatNumber(num) {
            return num.toLocaleString();
        }

        function getTimeAgo(date) {
            const seconds = Math.floor((Date.now() - date.getTime()) / 1000);
            if (seconds < 60) return `${seconds}s ago`;
            const minutes = Math.floor(seconds / 60);
            if (minutes < 60) return `${minutes}m ago`;
            const hours = Math.floor(minutes / 60);
            if (hours < 24) return `${hours}h ago`;
            const days = Math.floor(hours / 24);
            return `${days}d ago`;
        }

        async function loadErrorTrend() {
            const days = document.getElementById('errorTrendDays').value || '7';
            try {
                const response = await fetch(`${API_BASE}/api/admin/error-trend?days=${days}`);
                const data = await response.json();
                renderErrorTrendChart(data.trendData, data.bucketSize);
            } catch (err) {
                console.error('Failed to load error trend:', err);
                document.getElementById('errorTrendChart').innerHTML = '<div style="color: #ef4444; text-align: center; padding: 20px;">Failed to load trend data</div>';
            }
        }

        function renderErrorTrendChart(trendData, bucketSizeHours) {
            const chartEl = document.getElementById('errorTrendChart');
            if (!trendData || trendData.length === 0) {
                chartEl.innerHTML = '<div style="color: #9e9eb0; text-align: center; padding: 40px; font-size: 0.9em;">No data available</div>';
                return;
            }

            const width = chartEl.offsetWidth - 40;
            const height = 130;
            const padding = { top: 10, right: 20, bottom: 30, left: 50 };
            const chartWidth = width - padding.left - padding.right;
            const chartHeight = height - padding.top - padding.bottom;

            // Find min/max for scaling
            const errorRates = trendData.map(d => d.errorRate);
            const maxRate = Math.max(...errorRates, 5); // At least 5% for visibility
            const minRate = 0;

            // X-axis: time
            const timeRange = trendData[trendData.length - 1].time - trendData[0].time;
            const xScale = (time) => padding.left + ((time - trendData[0].time) / timeRange) * chartWidth;

            // Y-axis: error rate (0 to maxRate%)
            const yScale = (rate) => padding.top + chartHeight - (rate / maxRate) * chartHeight;

            // Generate SVG path for line
            let path = '';
            trendData.forEach((point, i) => {
                const x = xScale(point.time);
                const y = yScale(point.errorRate);
                if (i === 0) {
                    path += `M ${x} ${y} `;
                } else {
                    path += `L ${x} ${y} `;
                }
            });

            // Generate area fill (for visual effect)
            let areaPath = path;
            if (trendData.length > 0) {
                const firstX = xScale(trendData[0].time);
                const lastX = xScale(trendData[trendData.length - 1].time);
                const bottomY = padding.top + chartHeight;
                areaPath += `L ${lastX} ${bottomY} L ${firstX} ${bottomY} Z`;
            }

            // Generate grid lines and labels
            const gridLines = [];
            const yLabels = [];
            for (let i = 0; i <= 5; i++) {
                const rate = (maxRate / 5) * i;
                const y = yScale(rate);
                gridLines.push(`<line x1="${padding.left}" y1="${y}" x2="${width - padding.right}" y2="${y}" stroke="#2a2a3e" stroke-width="1" stroke-dasharray="2,2"/>`);
                yLabels.push(`<text x="${padding.left - 10}" y="${y + 4}" fill="#9e9eb0" font-size="10" text-anchor="end">${rate.toFixed(1)}%</text>`);
            }

            // X-axis labels (show first, middle, last)
            const xLabels = [];
            if (trendData.length > 0) {
                const labelIndices = [0, Math.floor(trendData.length / 2), trendData.length - 1];
                labelIndices.forEach(idx => {
                    if (trendData[idx]) {
                        const x = xScale(trendData[idx].time);
                        const date = new Date(trendData[idx].time);
                        const label = bucketSizeHours >= 24 
                            ? date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })
                            : date.toLocaleTimeString('en-US', { hour: 'numeric', hour12: true });
                        xLabels.push(`<text x="${x}" y="${height - 5}" fill="#9e9eb0" font-size="10" text-anchor="middle">${label}</text>`);
                    }
                });
            }

            // Critical threshold line (2%)
            const criticalY = yScale(2);
            const warningY = yScale(0.5);

            chartEl.innerHTML = `
                <svg width="${width}" height="${height}" style="display: block;">
                    ${gridLines.join('')}
                    <line x1="${padding.left}" y1="${criticalY}" x2="${width - padding.right}" y2="${criticalY}" stroke="#ef4444" stroke-width="1.5" stroke-dasharray="4,4" opacity="0.6"/>
                    <line x1="${padding.left}" y1="${warningY}" x2="${width - padding.right}" y2="${warningY}" stroke="#fbbf24" stroke-width="1" stroke-dasharray="2,2" opacity="0.5"/>
                    <path d="${areaPath}" fill="url(#errorGradient)" opacity="0.3"/>
                    <path d="${path}" fill="none" stroke="#ef4444" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    ${trendData.map((point, i) => {
                        const x = xScale(point.time);
                        const y = yScale(point.errorRate);
                        const color = point.errorRate >= 2 ? '#ef4444' : point.errorRate >= 0.5 ? '#fbbf24' : '#4ade80';
                        return `<circle cx="${x}" cy="${y}" r="3" fill="${color}" stroke="#1a1a2e" stroke-width="1"/>`;
                    }).join('')}
                    <defs>
                        <linearGradient id="errorGradient" x1="0%" y1="0%" x2="0%" y2="100%">
                            <stop offset="0%" style="stop-color:#ef4444;stop-opacity:0.4" />
                            <stop offset="100%" style="stop-color:#ef4444;stop-opacity:0" />
                        </linearGradient>
                    </defs>
                    ${yLabels.join('')}
                    ${xLabels.join('')}
                    <line x1="${padding.left}" y1="${padding.top}" x2="${padding.left}" y2="${height - padding.bottom}" stroke="#3a3a4e" stroke-width="1"/>
                    <line x1="${padding.left}" y1="${height - padding.bottom}" x2="${width - padding.right}" y2="${height - padding.bottom}" stroke="#3a3a4e" stroke-width="1"/>
                </svg>
                <div style="display: flex; gap: 15px; margin-top: 8px; font-size: 0.75em; color: #9e9eb0; justify-content: center;">
                    <span><span style="color: #4ade80;">‚óè</span> &lt;0.5% (Good)</span>
                    <span><span style="color: #fbbf24;">‚óè</span> 0.5-2% (Warning)</span>
                    <span><span style="color: #ef4444;">‚óè</span> &gt;2% (Critical)</span>
                </div>
            `;
        }

        // Load dashboard on page load
        loadDashboard();
        
        // Load error trend after dashboard loads
        setTimeout(() => {
            loadErrorTrend();
        }, 500);
        
        // Auto-refresh every 5 minutes
        setInterval(() => {
            loadDashboard();
            loadErrorTrend();
        }, 5 * 60 * 1000);
    </script>
</body>
</html>


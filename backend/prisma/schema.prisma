// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            String    @id
  email         String    @unique
  name          String?
  emailVerified Boolean   @default(false)
  image         String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @default(now()) @updatedAt
  sessions      Session[]
  accounts      Account[]

  Profile             Profile?
  preferences         UserPreferences?
  affirmationSessions AffirmationSession[]
  subscription        UserSubscription?

  @@map("user")
}

model Session {
  id        String   @id
  expiresAt DateTime
  token     String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  ipAddress String?
  userAgent String?
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([token])
  @@map("session")
}

model Account {
  id                    String    @id
  accountId             String
  providerId            String
  userId                String
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  accessToken           String?
  refreshToken          String?
  idToken               String?
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  password              String?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  @@map("account")
}

model Verification {
  id         String   @id
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @default(now()) @updatedAt

  @@map("verification")
}

model Profile {
  id     Int    @id @default(autoincrement())
  handle String @unique
  user   User   @relation(fields: [userId], references: [id])
  userId String @unique
}

model UserPreferences {
  id                 String   @id @default(cuid())
  userId             String   @unique
  user               User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  voice              String   @default("neutral") // neutral/confident/premium1-8
  pace               String   @default("normal") // slow/normal
  noise              String   @default("rain") // rain/brown/none
  pronounStyle       String   @default("you") // you/i
  intensity          String   @default("gentle") // gentle/assertive
  affirmationSpacing Int      @default(8) // Seconds between affirmations (default 8 seconds)
  updatedAt          DateTime @updatedAt

  @@map("user_preferences")
}

model AffirmationSession {
  id               String   @id @default(cuid())
  userId           String
  user             User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  goal             String // sleep/focus/calm/manifest
  title            String
  affirmations     String // JSON string of affirmation lines (legacy - kept for backward compatibility)
  voiceId          String
  pace             String
  noise            String
  lengthSec        Int // duration in seconds
  audioUrl         String? // Legacy - single session audio file (deprecated)
  silenceBetweenMs Int      @default(5000) // Silence duration between affirmations in milliseconds
  isFavorite       Boolean  @default(false)
  binauralCategory String? // delta/theta/alpha/beta/gamma
  binauralHz       String? // e.g., "0.5-4", "4-8", "8-14", "14-30", "30-100"
  createdAt        DateTime @default(now())

  sessionAffirmations SessionAffirmation[] // Individual affirmations with audio

  // Indexes for common query patterns
  @@index([userId, createdAt]) // For fetching user sessions ordered by date
  @@index([userId, isFavorite]) // For fetching user's favorite sessions
  @@index([goal]) // For filtering sessions by goal type
  @@map("affirmation_session")
}

// Junction table linking sessions to individual affirmations with position and silence
model SessionAffirmation {
  id             String             @id @default(cuid())
  sessionId      String
  session        AffirmationSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  affirmationId  String
  affirmation    AffirmationLine    @relation(fields: [affirmationId], references: [id], onDelete: Cascade)
  position       Int // Order in session (1, 2, 3, ...)
  silenceAfterMs Int                @default(5000) // Silence duration after this affirmation in milliseconds
  createdAt      DateTime           @default(now())

  @@unique([sessionId, position]) // Ensure unique position per session
  @@index([sessionId]) // Fast lookup by session
  @@index([affirmationId]) // Fast lookup by affirmation
  @@map("session_affirmation")
}

model UserSubscription {
  id                          String    @id @default(cuid())
  userId                      String    @unique
  user                        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  tier                        String    @default("free") // free/pro
  status                      String    @default("active") // active/cancelled/expired
  billingPeriod               String? // monthly/yearly (null for free)
  currentPeriodStart          DateTime?
  currentPeriodEnd            DateTime?
  cancelAtPeriodEnd           Boolean   @default(false)
  customSessionsUsedThisMonth Int       @default(0)
  lastResetDate               DateTime  @default(now())
  createdAt                   DateTime  @default(now())
  updatedAt                   DateTime  @updatedAt

  // Indexes for monthly reset queries
  @@index([lastResetDate, tier]) // For finding subscriptions that need reset
  @@index([tier, status]) // For filtering by subscription tier and status
  @@map("user_subscription")
}

model TtsCache {
  id                 String   @id @default(cuid())
  cacheKey           String   @unique // SHA-256 hash of affirmations + voice + pace + spacing
  filePath           String // Path to cached audio file
  fileSize           Int // File size in bytes
  affirmationsCount  Int // Number of affirmations in this audio
  voiceType          String // neutral/confident/whisper
  pace               String // slow/normal
  affirmationSpacing Int // Seconds between affirmations
  createdAt          DateTime @default(now())
  lastAccessedAt     DateTime @default(now()) @updatedAt
  accessCount        Int      @default(0) // Track how many times this cache was used

  // Indexes for cleanup and monitoring
  @@index([lastAccessedAt]) // For finding old unused cache entries
  @@index([cacheKey]) // Fast lookup by cache key
  @@map("tts_cache")
}

// Individual affirmation library for pool-based matching
model AffirmationLine {
  id              String   @id @default(cuid())
  text            String // "I am calm and centered"
  goal            String // sleep, focus, calm, manifest
  tags            String[] // ["anxiety", "bedtime", "stress"] - stored as JSON array in PostgreSQL
  emotion         String? // "peace", "confidence", "safety"
  useCount        Int      @default(0) // Track popularity
  userRating      Float? // Average user rating (1-5)
  ttsAudioUrl     String? // Pre-generated TTS URL (optional) - DEPRECATED: Use AffirmationAudio instead
  ttsVoiceId      String? // Which voice was used - DEPRECATED: Use AffirmationAudio instead
  audioDurationMs Int? // Duration of the audio file in milliseconds - DEPRECATED: Use AffirmationAudio instead
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  sessionAffirmations SessionAffirmation[] // Affirmations used in sessions
  audioVersions       AffirmationAudio[] // Multiple voice versions of this affirmation

  @@index([goal, useCount])
  @@index([goal]) // For filtering by goal
  @@map("affirmation_line")
}

// Multiple audio versions per affirmation (different voices)
model AffirmationAudio {
  id            String          @id @default(cuid())
  affirmationId String
  affirmation   AffirmationLine @relation(fields: [affirmationId], references: [id], onDelete: Cascade)
  voiceId       String // neutral, confident, premium1-8
  pace          String          @default("slow") // Always slow
  cacheKey      String // SHA-256 hash of text + voiceId + goal + pace
  audioUrl      String // URL to the audio file
  durationMs    Int // Duration in milliseconds
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt

  @@unique([affirmationId, voiceId]) // One audio per voice (pace is always slow)
  @@index([affirmationId]) // Fast lookup by affirmation
  @@index([cacheKey]) // Fast lookup by cache key
  @@map("affirmation_audio")
}

// Pre-built session templates for exact matching
model SessionTemplate {
  id               String   @id @default(cuid())
  title            String
  goal             String // sleep, focus, calm, manifest
  intent           String // "help me sleep" "reduce anxiety"
  intentKeywords   String[] // Keywords extracted from intent for matching
  affirmationIds   String[] // References to AffirmationLine IDs (stored as JSON array)
  binauralCategory String?
  binauralHz       String?
  lengthSec        Int
  useCount         Int      @default(0)
  userRating       Float? // Average user rating (1-5)
  isDefault        Boolean  @default(false) // Your 8 default sessions
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@index([goal, useCount])
  @@index([goal, isDefault])
  @@index([intentKeywords]) // For keyword-based matching
  @@map("session_template")
}

// Track what gets generated (for library building and analytics)
model GenerationLog {
  id               String   @id @default(cuid())
  userId           String?
  userIntent       String
  goal             String
  matchType        String // "exact", "pooled", "generated", "fallback"
  affirmationsUsed String[] // IDs of affirmations used (or full text if generated)
  sessionId        String? // Reference to AffirmationSession if created
  templateId       String? // Reference to SessionTemplate if exact match
  wasRated         Boolean  @default(false)
  userRating       Int? // 1-5 stars
  wasReplayed      Boolean  @default(false) // Did they play it again?
  apiCost          Float    @default(0) // Track actual cost in dollars
  confidence       Float? // Matching confidence score (0-1)
  createdAt        DateTime @default(now())

  @@index([userId, createdAt])
  @@index([goal, matchType])
  @@index([matchType, createdAt]) // For analytics
  @@map("generation_log")
}
